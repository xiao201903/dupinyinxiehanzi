<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>çœ‹æ‹¼éŸ³å†™è¯è¯­ä¸“ä¸šç”Ÿæˆå·¥å…· - å®Œæ•´ç»ˆæç‰ˆ</title>
    <script src="https://unpkg.com/pinyin-pro"></script>
    <link href="https://fonts.googleapis.com/css2?family=Andika&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3b82f6;
            --grid-size: 60px;
            --grid-color: #d32f2f;
            --pinyin-size: 24px;
            --hanzi-size: 36px;
            --row-gap: 20px;
            --word-gap: 30px;
        }

        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { margin: 0; background: #f1f5f9; font-family: 'Noto Sans SC', sans-serif; display: flex; height: 100vh; overflow: hidden; }

        /* å·¦ä¾§é…ç½®é¢æ¿ */
        .sidebar { width: 380px; background: white; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; box-shadow: 2px 0 10px rgba(0,0,0,0.05); z-index: 10; flex-shrink: 0; }
        .config-scroll { padding: 20px; overflow-y: auto; flex: 1; }
        .group-title { font-size: 15px; font-weight: 700; color: #1e293b; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        
        .item-label { display: block; font-size: 13px; color: #64748b; margin: 10px 0 5px; }
        input[type="text"], textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; outline: none; transition: border 0.2s; }
        input[type="text"]:focus, textarea:focus { border-color: var(--primary); }
        textarea { resize: vertical; }
        
        input[type="range"] { width: 100%; accent-color: var(--primary); margin: 8px 0 15px; }
        .val-tag { color: var(--primary); font-weight: bold; }

        .check-group { display: flex; flex-wrap: wrap; gap: 12px; margin: 10px 0 15px; }
        .check-item { display: flex; align-items: center; gap: 5px; font-size: 13px; cursor: pointer; color: #334155; }

        /* å³ä¾§é¢„è§ˆåŒº */
        .preview-area { flex: 1; background: #94a3b8; overflow-y: auto; padding: 40px; display: flex; flex-direction: column; align-items: center; gap: 25px; }
        
        /* ä¸¥æ ¼çš„ A4 å°ºå¯¸è®¾å®š */
        .sheet { 
            width: 210mm; 
            height: 297mm; /* å›ºå®šé«˜åº¦ä»¥è§¦å‘æº¢å‡ºæ£€æµ‹ */
            background: white; 
            padding: 15mm; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            flex-shrink: 0;
            background-color: #fff;
        }

        .sheet-header { text-align: center; margin-bottom: 8mm; flex-shrink: 0; }
        .sheet-title { font-size: 28px; font-weight: bold; margin-bottom: 4mm; color: #000; }
        .sheet-meta { display: flex; justify-content: center; gap: 10mm; font-size: 14px; color: #000; }
        .meta-item span { border-bottom: 1px solid #000; padding: 0 15px; min-width: 60px; display: inline-block; }

        /* è¯è¯­å®¹å™¨ï¼šè¶…å‡ºé«˜åº¦éšè—å¹¶è§¦å‘ JS æ£€æµ‹ */
        .sheet-content { 
            flex: 1; 
            overflow: hidden; 
            display: flex; 
            flex-wrap: wrap; 
            align-content: flex-start; 
            row-gap: var(--row-gap); 
            column-gap: var(--word-gap); 
        }

        .word-block { display: flex; break-inside: avoid; }
        .char-unit { display: flex; flex-direction: column; align-items: center; }
        
        .pinyin-box { height: 35px; font-family: 'Andika', sans-serif; font-size: var(--pinyin-size); color: #333; display: flex; align-items: flex-end; justify-content: center; width: 100%; padding-bottom: 2px;}
        .grid-box { width: var(--grid-size); height: var(--grid-size); border: 1px solid var(--grid-color); position: relative; margin-left: -1px; display: flex; justify-content: center; align-items: center; }
        .char-unit:first-child .grid-box { margin-left: 0; }

        /* æ±‰å­—å±‚ */
        .hanzi-content { font-family: "æ¥·ä½“", "KaiTi", serif; font-size: var(--hanzi-size); color: #333; position: absolute; }
        .hanzi-trace { color: #000; } /* æçº¢æ˜¾ç¤ºæ­£å¸¸é¢œè‰² */
        .hanzi-answer { color: #cbd5e1; } /* ç­”æ¡ˆæ¨¡å¼æ˜¾ç¤ºæµ…ç°è‰² */

        /* æ ¼çº¿ SVG */
        .bg-tian { background-image: url("data:image/svg+xml,%3Csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3E%3Cline x1='50%25' y1='0' x2='50%25' y2='100%25' stroke='%23d32f2f' stroke-width='0.5' stroke-dasharray='3,3'/%3E%3Cline x1='0' y1='50%25' x2='100%25' y2='50%25' stroke='%23d32f2f' stroke-width='0.5' stroke-dasharray='3,3'/%3E%3C/svg%3E"); }
        .bg-mi { background-image: url("data:image/svg+xml,%3Csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3E%3Cline x1='50%25' y1='0' x2='50%25' y2='100%25' stroke='%23d32f2f' stroke-width='0.5' stroke-dasharray='3,3'/%3E%3Cline x1='0' y1='50%25' x2='100%25' y2='50%25' stroke='%23d32f2f' stroke-width='0.5' stroke-dasharray='3,3'/%3E%3Cline x1='0' y1='0' x2='100%25' y2='100%25' stroke='%23d32f2f' stroke-width='0.5' stroke-dasharray='3,3'/%3E%3Cline x1='100%25' y1='0' x2='0' y2='100%25' stroke='%23d32f2f' stroke-width='0.5' stroke-dasharray='3,3'/%3E%3C/svg%3E"); }

        .btn-export { width: 100%; padding: 15px; background: #f59e0b; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; transition: 0.2s; }
        .btn-export:hover { background: #d97706; }
        .tips { font-size: 12px; color: #64748b; line-height: 1.6; padding: 10px; background: #f8fafc; border-radius: 6px; margin-top: 5px; border: 1px solid #e2e8f0; }

        @media print {
            body { background: white; overflow: visible; height: auto; }
            .sidebar { display: none !important; }
            .preview-area { padding: 0; background: white; overflow: visible; gap: 0; display: block; }
            .sheet { margin: 0; box-shadow: none; border: none; page-break-after: always; height: 297mm; }
        }
    </style>
</head>
<body>

<aside class="sidebar">
    <div class="config-scroll">
        <div class="group-title">ğŸ·ï¸ æ ‡é¢˜ä¸è¡¨å¤´</div>
        <input type="text" id="docTitle" value="çœ‹æ‹¼éŸ³å†™è¯è¯­ç»ƒä¹ " oninput="render()">
        <div class="check-group">
            <label class="check-item"><input type="checkbox" id="showClass" checked onchange="render()"> ç­çº§</label>
            <label class="check-item"><input type="checkbox" id="showName" checked onchange="render()"> å§“å</label>
            <label class="check-item"><input type="checkbox" id="showScore" checked onchange="render()"> å¾—åˆ†</label>
        </div>
        
        <div class="group-title" style="margin-top:10px;">ğŸ“ è¯è¯­å½•å…¥</div>
        <textarea id="wordInput" rows="7" oninput="render()" placeholder="è¾“å…¥è¯è¯­...">æ—©ä¸Š*&#10;ç»ƒä¹ &#10;é‡(zhÃ²ng)é‡*&#10;éŸ³*ä¹(yuÃ¨)&#10;ä½ å¥½</textarea>
        <div class="tips">
            ğŸ’¡ <b>è¾“å…¥æŠ€å·§ï¼š</b><br>
            â€¢ å­—ååŠ  <code>*</code> æ˜¾ç¤ºè¯¥æ±‰å­—ï¼ˆç”¨ä½œæç¤ºæˆ–æçº¢ï¼‰<br>
            â€¢ å­—ååŠ  <code>(æ‹¼éŸ³)</code> å¼ºåˆ¶çº æ­£å¤šéŸ³å­—ï¼Œå¦‚ <code>ä¹(yuÃ¨)</code><br>
            â€¢ è¯è¯­è¿‡å¤šæ—¶ï¼Œå·¥å…·ä¼šè‡ªåŠ¨ä¸ºæ‚¨ç”Ÿæˆç¬¬äºŒé¡µ
        </div>
        
        <div class="group-title" style="margin-top:20px;">âš™ï¸ åŠŸèƒ½æ§åˆ¶</div>
        <div class="check-group" style="background: #eff6ff; padding: 10px; border-radius: 6px; border: 1px solid #bfdbfe;">
            <label class="check-item" style="color: #1e3a8a; font-weight: bold;">
                <input type="checkbox" id="showAnswer" onchange="render()"> ğŸ‘ï¸ å¼€å¯ç­”æ¡ˆå‚è€ƒæ¨¡å¼
            </label>
        </div>

        <div class="group-title" style="margin-top:20px;">ğŸ“Š æ ¼å¼ä¸æ’ç‰ˆ</div>
        <div class="check-group">
            <label class="check-item"><input type="radio" name="gridType" value="tian" checked onchange="render()"> ç”°å­—æ ¼</label>
            <label class="check-item"><input type="radio" name="gridType" value="mi" onchange="render()"> ç±³å­—æ ¼</label>
        </div>

        <span class="item-label">æ ¼å­å¤§å°: <span id="sizeVal" class="val-tag">60px</span></span>
        <input type="range" id="sizeRange" min="40" max="90" value="60" oninput="updateStyles()">

        <span class="item-label">è¯è¯­é—´è·: <span id="wordGapVal" class="val-tag">30px</span></span>
        <input type="range" id="wordGapRange" min="10" max="60" value="30" oninput="updateStyles()">

        <span class="item-label">è¡Œé—´è·: <span id="rowGapVal" class="val-tag">20px</span></span>
        <input type="range" id="rowGapRange" min="10" max="60" value="20" oninput="updateStyles()">

        <span class="item-label">æ‹¼éŸ³å­—ä½“å¤§å°: <span id="pySizeVal" class="val-tag">24px</span></span>
        <input type="range" id="pySizeRange" min="12" max="36" value="24" oninput="updateStyles()">

        <span class="item-label">æ±‰å­—å­—ä½“å¤§å°: <span id="hzSizeVal" class="val-tag">36px</span></span>
        <input type="range" id="hzSizeRange" min="20" max="70" value="36" oninput="updateStyles()">

        <button class="btn-export" onclick="window.print()">ğŸ–¨ï¸ æ‰“å° / å¯¼å‡º PDF</button>
    </div>
</aside>

<main class="preview-area" id="previewArea"></main>

<script>
    const { pinyin } = pinyinPro;

    // æ›´æ–° CSS å˜é‡
    function updateStyles() {
        const root = document.documentElement;
        
        const size = document.getElementById('sizeRange').value;
        const wordGap = document.getElementById('wordGapRange').value;
        const rowGap = document.getElementById('rowGapRange').value;
        const pySize = document.getElementById('pySizeRange').value;
        const hzSize = document.getElementById('hzSizeRange').value;

        document.getElementById('sizeVal').innerText = size + 'px';
        document.getElementById('wordGapVal').innerText = wordGap + 'px';
        document.getElementById('rowGapVal').innerText = rowGap + 'px';
        document.getElementById('pySizeVal').innerText = pySize + 'px';
        document.getElementById('hzSizeVal').innerText = hzSize + 'px';

        root.style.setProperty('--grid-size', size + 'px');
        root.style.setProperty('--word-gap', wordGap + 'px');
        root.style.setProperty('--row-gap', rowGap + 'px');
        root.style.setProperty('--pinyin-size', pySize + 'px');
        root.style.setProperty('--hanzi-size', hzSize + 'px');
        
        render(); // å¤§å°æ”¹å˜å¯èƒ½å¯¼è‡´é‡æ’ç‰ˆï¼ˆè§¦å‘åˆ†é¡µï¼‰ï¼Œå¿…é¡»é‡æ–°æ¸²æŸ“
    }

    // æ ¸å¿ƒè§£æå™¨ï¼šç²¾ç¡®é€å­—è§£ææ–‡æœ¬ï¼Œæ”¯æŒæ±‰å­—ã€æ‹¬å·æ‹¼éŸ³ã€æ˜Ÿå·
    function parseInput(text) {
        const lines = text.split('\n');
        const result = [];

        lines.forEach(line => {
            line = line.trim();
            if (!line) return;

            let charsData = [];
            let i = 0;
            
            while (i < line.length) {
                let char = line[i];
                
                // è·³è¿‡å•ç‹¬å­˜åœ¨çš„ç¬¦å·ï¼ˆé˜²æ­¢ç”¨æˆ·æ‰‹è¯¯å¤šæ‰“ï¼‰
                if (char === '*' || char === '(' || char === ')') {
                    i++; 
                    continue; 
                }

                let customPinyin = null;
                let isHint = false;
                let nextIdx = i + 1;

                // æ¢æµ‹åæ–¹æ˜¯å¦ç´§è·Ÿè‡ªå®šä¹‰æ‹¼éŸ³ (xxx)
                if (nextIdx < line.length && line[nextIdx] === '(') {
                    let endIdx = line.indexOf(')', nextIdx);
                    if (endIdx !== -1) {
                        customPinyin = line.substring(nextIdx + 1, endIdx);
                        nextIdx = endIdx + 1;
                    }
                }

                // æ¢æµ‹åæ–¹æ˜¯å¦ç´§è·Ÿæ˜Ÿå· *
                if (nextIdx < line.length && line[nextIdx] === '*') {
                    isHint = true;
                    nextIdx++;
                }

                charsData.push({ char, pinyin: customPinyin, isHint });
                i = nextIdx;
            }

            // æå–æ‰€æœ‰æ±‰å­—ï¼Œè°ƒç”¨åº“è‡ªåŠ¨ç”Ÿæˆç¼ºå¤±çš„æ‹¼éŸ³
            let pureText = charsData.map(item => item.char).join('');
            let autoPinyins = pinyin(pureText, { type: 'array' });

            charsData.forEach((item, idx) => {
                if (!item.pinyin) {
                    item.pinyin = autoPinyins[idx] || ''; // è‹¥æ— è‡ªå®šä¹‰ï¼Œåˆ™ç”¨è‡ªåŠ¨ç”Ÿæˆçš„
                }
            });

            if (charsData.length > 0) result.push(charsData);
        });
        
        return result;
    }

    // åˆ›å»ºæ–°çš„ A4 çº¸å¼ é¡µé¢
    function createNewSheet() {
        const sheet = document.createElement('div');
        sheet.className = 'sheet';
        
        const title = document.getElementById('docTitle').value;
        const showAnswer = document.getElementById('showAnswer').checked;
        
        // ç”Ÿæˆè¡¨å¤´åŠ¨æ€ä¿¡æ¯
        let metaHTML = '';
        if (showAnswer) {
            metaHTML = `<div class="meta-item" style="color:#ef4444; font-weight:bold; border: 1px solid #ef4444; padding: 2px 10px; border-radius: 4px;">æœ¬é¡µä¸ºç­”æ¡ˆå‚è€ƒ</div>`;
        } else {
            if(document.getElementById('showClass').checked) metaHTML += `<div class="meta-item">ç­çº§ï¼š<span></span></div>`;
            if(document.getElementById('showName').checked) metaHTML += `<div class="meta-item">å§“åï¼š<span></span></div>`;
            if(document.getElementById('showScore').checked) metaHTML += `<div class="meta-item">å¾—åˆ†ï¼š<span></span></div>`;
        }

        sheet.innerHTML = `
            <div class="sheet-header">
                <div class="sheet-title">${title}</div>
                <div class="sheet-meta">${metaHTML}</div>
            </div>
            <div class="sheet-content"></div>
        `;
        return sheet;
    }

    // ä¸»æ¸²æŸ“å‡½æ•°
    function render() {
        const previewArea = document.getElementById('previewArea');
        previewArea.innerHTML = ''; // æ¸…ç©ºé¢„è§ˆåŒº
        
        const wordData = parseInput(document.getElementById('wordInput').value);
        const gridType = document.querySelector('input[name="gridType"]:checked').value;
        const showAnswer = document.getElementById('showAnswer').checked;
        const bgClass = gridType === 'tian' ? 'bg-tian' : 'bg-mi';

        let currentSheet = createNewSheet();
        previewArea.appendChild(currentSheet);
        let contentArea = currentSheet.querySelector('.sheet-content');

        wordData.forEach(wordGroup => {
            const wordBlock = document.createElement('div');
            wordBlock.className = 'word-block';

            wordGroup.forEach(item => {
                const unit = document.createElement('div');
                unit.className = 'char-unit';
                
                // å­—ä½“æ˜¾ç¤ºé€»è¾‘ï¼šæç¤ºå­—æ˜¾ç¤ºæ­£å¸¸é»‘å­—ï¼Œç­”æ¡ˆæ¨¡å¼æ˜¾ç¤ºæµ…ç°å­—ï¼Œå…¶ä½™ä¸æ˜¾ç¤º
                let hanziClass = '';
                let displayChar = '';
                
                if (item.isHint) {
                    hanziClass = 'hanzi-trace';
                    displayChar = item.char;
                } else if (showAnswer) {
                    hanziClass = 'hanzi-answer';
                    displayChar = item.char;
                }

                unit.innerHTML = `
                    <div class="pinyin-box">${item.pinyin}</div>
                    <div class="grid-box ${bgClass}">
                        ${displayChar ? `<div class="hanzi-content ${hanziClass}">${displayChar}</div>` : ''}
                    </div>
                `;
                wordBlock.appendChild(unit);
            });

            contentArea.appendChild(wordBlock);

            // å…³é”®ï¼šæ£€æµ‹æ˜¯å¦è¶…å‡ºå½“å‰ A4 çº¸å®¹é‡
            // å¦‚æœå†…å®¹çœŸå®é«˜åº¦ > å®¹å™¨è®¾å®šé«˜åº¦ï¼Œè¯´æ˜æº¢å‡ºäº†
            if (contentArea.scrollHeight > contentArea.clientHeight + 2) { 
                contentArea.removeChild(wordBlock); // ä»å½“å‰é¡µç§»é™¤
                
                // åˆ›å»ºæ–°é¡µé¢
                currentSheet = createNewSheet();
                previewArea.appendChild(currentSheet);
                contentArea = currentSheet.querySelector('.sheet-content');
                
                // å°†è¯è¯­æ”¾åˆ°æ–°é¡µ
                contentArea.appendChild(wordBlock);
            }
        });
    }

    window.onload = () => {
        updateStyles(); // åˆå§‹åŒ–æ—¶å…ˆåŒæ­¥ä¸€æ¬¡æ ·å¼ï¼Œå†è§¦å‘ render
    };
</script>
</body>
</html>
