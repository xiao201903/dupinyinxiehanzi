<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çœ‹æ‹¼éŸ³å†™è¯è¯­ä¸“ä¸šç”Ÿæˆå·¥å…· - ç§»åŠ¨é€‚é…ç‰ˆ</title>
    <script src="https://unpkg.com/pinyin-pro"></script>
    <link href="https://fonts.googleapis.com/css2?family=Andika&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3b82f6;
            --grid-size: 60px;
            --grid-color: #d32f2f;
            --pinyin-size: 24px;
            --hanzi-size: 36px;
            --row-gap: 20px;
            --word-gap: 30px;
            --page-margin: 15mm;
        }

        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { margin: 0; background: #f1f5f9; font-family: 'Noto Sans SC', sans-serif; display: flex; height: 100vh; overflow: hidden; flex-direction: row; }

        /* å·¦ä¾§/ä¸Šæ–¹é…ç½®é¢æ¿ */
        .sidebar { width: 380px; background: white; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; box-shadow: 2px 0 10px rgba(0,0,0,0.05); z-index: 10; flex-shrink: 0; }
        .config-scroll { padding: 20px; overflow-y: auto; flex: 1; }
        .group-title { font-size: 15px; font-weight: 700; color: #1e293b; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        
        .item-label { display: flex; justify-content: space-between; font-size: 13px; color: #64748b; margin: 10px 0 5px; align-items: center; }
        input[type="text"], textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; outline: none; transition: border 0.2s; }
        input[type="text"]:focus, textarea:focus { border-color: var(--primary); }
        textarea { resize: vertical; }
        
        input[type="range"] { width: 100%; accent-color: var(--primary); margin: 8px 0 15px; }
        .val-tag { color: var(--primary); font-weight: bold; font-size: 13px; background: #eff6ff; padding: 2px 6px; border-radius: 4px; }

        .check-group { display: flex; flex-wrap: wrap; gap: 12px; margin: 10px 0 15px; }
        .check-item { display: flex; align-items: center; gap: 5px; font-size: 13px; cursor: pointer; color: #334155; }

        /* å³ä¾§é¢„è§ˆåŒº */
        .preview-area { flex: 1; background: #94a3b8; overflow: auto; padding: 40px; display: flex; flex-direction: column; align-items: center; gap: 25px; }
        
        /* ä¸¥æ ¼çš„ A4 å°ºå¯¸è®¾å®š */
        .sheet { 
            width: 210mm; 
            height: 297mm; 
            background: white; 
            /* ä¸Šä¸‹å›ºå®š 15mmï¼Œå·¦å³ç”± CSS å˜é‡æ§åˆ¶ */
            padding: 15mm var(--page-margin) 15mm var(--page-margin); 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            flex-shrink: 0;
        }

        .sheet-header { text-align: center; margin-bottom: 8mm; flex-shrink: 0; }
        .sheet-title { font-size: 28px; font-weight: bold; margin-bottom: 4mm; color: #000; }
        .sheet-meta { display: flex; justify-content: center; gap: 10mm; font-size: 14px; color: #000; }
        .meta-item span { border-bottom: 1px solid #000; padding: 0 15px; min-width: 60px; display: inline-block; }

        /* è¯è¯­å®¹å™¨ */
        .sheet-content { 
            flex: 1; 
            overflow: hidden; 
            display: flex; 
            flex-wrap: wrap; 
            align-content: flex-start; 
            row-gap: var(--row-gap); 
            column-gap: var(--word-gap); 
        }

        .word-block { display: flex; break-inside: avoid; }
        .char-unit { display: flex; flex-direction: column; align-items: center; }
        
        .pinyin-box { height: calc(var(--pinyin-size) * 1.5); font-family: 'Andika', sans-serif; font-size: var(--pinyin-size); color: #333; display: flex; align-items: flex-end; justify-content: center; width: 100%; padding-bottom: 2px;}
        .grid-box { width: var(--grid-size); height: var(--grid-size); border: 1px solid var(--grid-color); position: relative; margin-left: -1px; display: flex; justify-content: center; align-items: center; }
        .char-unit:first-child .grid-box { margin-left: 0; }

        .hanzi-content { font-family: "æ¥·ä½“", "KaiTi", serif; font-size: var(--hanzi-size); color: #333; position: absolute; }
        .hanzi-trace { color: #000; } 
        .hanzi-answer { color: #cbd5e1; } 

        .bg-tian { background-image: url("data:image/svg+xml,%3Csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3E%3Cline x1='50%25' y1='0' x2='50%25' y2='100%25' stroke='%23d32f2f' stroke-width='0.5' stroke-dasharray='3,3'/%3E%3Cline x1='0' y1='50%25' x2='100%25' y2='50%25' stroke='%23d32f2f' stroke-width='0.5' stroke-dasharray='3,3'/%3E%3C/svg%3E"); }
        .bg-mi { background-image: url("data:image/svg+xml,%3Csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3E%3Cline x1='50%25' y1='0' x2='50%25' y2='100%25' stroke='%23d32f2f' stroke-width='0.5' stroke-dasharray='3,3'/%3E%3Cline x1='0' y1='50%25' x2='100%25' y2='50%25' stroke='%23d32f2f' stroke-width='0.5' stroke-dasharray='3,3'/%3E%3Cline x1='0' y1='0' x2='100%25' y2='100%25' stroke='%23d32f2f' stroke-width='0.5' stroke-dasharray='3,3'/%3E%3Cline x1='100%25' y1='0' x2='0' y2='100%25' stroke='%23d32f2f' stroke-width='0.5' stroke-dasharray='3,3'/%3E%3C/svg%3E"); }

        .btn-export { width: 100%; padding: 15px; background: #f59e0b; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; transition: 0.2s; }
        .btn-export:hover { background: #d97706; }
        .tips { font-size: 12px; color: #64748b; line-height: 1.6; padding: 10px; background: #f8fafc; border-radius: 6px; margin-top: 5px; border: 1px solid #e2e8f0; }

        /* ================= ç§»åŠ¨ç«¯å“åº”å¼é€‚é… ================= */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { width: 100%; height: 45vh; border-right: none; border-bottom: 2px solid #cbd5e1; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
            .preview-area { height: 55vh; padding: 15px; align-items: flex-start; /* é å·¦å¯¹é½æ–¹ä¾¿æ»‘åŠ¨ */ }
            .sheet { margin-bottom: 20px; }
        }

        /* æ‰“å°æ ·å¼ */
        @media print {
            body { background: white; overflow: visible; height: auto; display: block; }
            .sidebar { display: none !important; }
            .preview-area { padding: 0; background: white; overflow: visible; gap: 0; display: block; }
            .sheet { margin: 0; box-shadow: none; border: none; page-break-after: always; height: 297mm; }
        }
    </style>
</head>
<body>

<aside class="sidebar">
    <div class="config-scroll">
        <div class="group-title">ğŸ·ï¸ æ ‡é¢˜ä¸è¡¨å¤´</div>
        <input type="text" id="docTitle" value="çœ‹æ‹¼éŸ³å†™è¯è¯­ç»ƒä¹ " oninput="render()">
        <div class="check-group">
            <label class="check-item"><input type="checkbox" id="showClass" checked onchange="render()"> ç­çº§</label>
            <label class="check-item"><input type="checkbox" id="showName" checked onchange="render()"> å§“å</label>
            <label class="check-item"><input type="checkbox" id="showScore" checked onchange="render()"> å¾—åˆ†</label>
        </div>
        
        <div class="group-title" style="margin-top:10px;">ğŸ“ è¯è¯­å½•å…¥</div>
        <textarea id="wordInput" rows="5" oninput="render()" placeholder="è¾“å…¥è¯è¯­...">æ—©ä¸Š*&#10;ç»ƒä¹ &#10;é‡(zhÃ²ng)é‡*&#10;éŸ³*ä¹(yuÃ¨)</textarea>
        
        <div class="group-title" style="margin-top:20px;">âš™ï¸ åŠŸèƒ½æ§åˆ¶</div>
        <div class="check-group" style="background: #eff6ff; padding: 10px; border-radius: 6px; border: 1px solid #bfdbfe;">
            <label class="check-item" style="color: #1e3a8a; font-weight: bold;">
                <input type="checkbox" id="showAnswer" onchange="render()"> ğŸ‘ï¸ å¼€å¯ç­”æ¡ˆå‚è€ƒæ¨¡å¼
            </label>
        </div>

        <div class="group-title" style="margin-top:20px; display: flex; justify-content: space-between;">
            ğŸ“Š æ ¼å¼ä¸æ’ç‰ˆ
            <div class="check-group" style="margin: 0;">
                <label class="check-item"><input type="radio" name="unitType" value="px" checked onchange="switchUnit()"> px</label>
                <label class="check-item"><input type="radio" name="unitType" value="mm" onchange="switchUnit()"> mm</label>
            </div>
        </div>
        
        <div class="check-group">
            <label class="check-item"><input type="radio" name="gridType" value="tian" checked onchange="render()"> ç”°å­—æ ¼</label>
            <label class="check-item"><input type="radio" name="gridType" value="mi" onchange="render()"> ç±³å­—æ ¼</label>
        </div>

        <div class="item-label">å·¦å³é¡µè¾¹è·: <span id="marginVal" class="val-tag">15mm</span></div>
        <input type="range" id="marginRange" oninput="updateStyles()">

        <div class="item-label">æ ¼å­å¤§å°: <span id="sizeVal" class="val-tag">60px</span></div>
        <input type="range" id="sizeRange" oninput="updateStyles()">

        <div class="item-label">è¯è¯­é—´è·: <span id="wordGapVal" class="val-tag">30px</span></div>
        <input type="range" id="wordGapRange" oninput="updateStyles()">

        <div class="item-label">è¡Œé—´è·: <span id="rowGapVal" class="val-tag">20px</span></div>
        <input type="range" id="rowGapRange" oninput="updateStyles()">

        <div class="item-label">æ‹¼éŸ³å­—ä½“å¤§å°: <span id="pySizeVal" class="val-tag">24px</span></div>
        <input type="range" id="pySizeRange" oninput="updateStyles()">

        <div class="item-label">æ±‰å­—å­—ä½“å¤§å°: <span id="hzSizeVal" class="val-tag">36px</span></div>
        <input type="range" id="hzSizeRange" oninput="updateStyles()">

        <button class="btn-export" onclick="window.print()">ğŸ–¨ï¸ æ‰“å° / å¯¼å‡º PDF</button>
    </div>
</aside>

<main class="preview-area" id="previewArea"></main>

<script>
    const { pinyin } = pinyinPro;
    let currentUnit = 'px';

    // å®šä¹‰æ§ä»¶åœ¨ px å’Œ mm ä¸‹çš„å¯¹åº”å‚æ•° [æœ€å°å€¼, æœ€å¤§å€¼, é»˜è®¤åˆå§‹å€¼]
    // ç²—ç•¥æ¢ç®—ï¼š1mm â‰ˆ 3.8px
    const configMap = {
        marginRange:  { px: [20, 100, 56], mm: [5, 30, 15] },
        sizeRange:    { px: [40, 90, 60],  mm: [10, 25, 16] },
        wordGapRange: { px: [10, 80, 30],  mm: [2, 25, 8] },
        rowGapRange:  { px: [10, 80, 20],  mm: [2, 25, 6] },
        pySizeRange:  { px: [12, 36, 24],  mm: [3, 10, 6] },
        hzSizeRange:  { px: [20, 70, 36],  mm: [5, 20, 10] }
    };

    // åˆ‡æ¢å•ä½å¹¶é‡ç½®æ»‘å—çŠ¶æ€
    function switchUnit() {
        currentUnit = document.querySelector('input[name="unitType"]:checked').value;
        
        Object.keys(configMap).forEach(id => {
            const el = document.getElementById(id);
            const conf = configMap[id][currentUnit];
            el.min = conf[0];
            el.max = conf[1];
            el.value = conf[2]; // åˆ‡æ¢å•ä½æ—¶æ¢å¤åˆ°è¯¥å•ä½çš„é»˜è®¤æœ€ä½³å€¼
        });
        
        updateStyles();
    }

    // æ›´æ–° CSS å˜é‡
    function updateStyles() {
        const root = document.documentElement;
        
        const margin = document.getElementById('marginRange').value;
        const size = document.getElementById('sizeRange').value;
        const wordGap = document.getElementById('wordGapRange').value;
        const rowGap = document.getElementById('rowGapRange').value;
        const pySize = document.getElementById('pySizeRange').value;
        const hzSize = document.getElementById('hzSizeRange').value;

        // æ›´æ–°æ ‡ç­¾æ˜¾ç¤º
        document.getElementById('marginVal').innerText = margin + currentUnit;
        document.getElementById('sizeVal').innerText = size + currentUnit;
        document.getElementById('wordGapVal').innerText = wordGap + currentUnit;
        document.getElementById('rowGapVal').innerText = rowGap + currentUnit;
        document.getElementById('pySizeVal').innerText = pySize + currentUnit;
        document.getElementById('hzSizeVal').innerText = hzSize + currentUnit;

        // è®¾ç½® CSS å˜é‡
        root.style.setProperty('--page-margin', margin + currentUnit);
        root.style.setProperty('--grid-size', size + currentUnit);
        root.style.setProperty('--word-gap', wordGap + currentUnit);
        root.style.setProperty('--row-gap', rowGap + currentUnit);
        root.style.setProperty('--pinyin-size', pySize + currentUnit);
        root.style.setProperty('--hanzi-size', hzSize + currentUnit);
        
        render(); 
    }

    // æ ¸å¿ƒè§£æå™¨
    function parseInput(text) {
        const lines = text.split('\n');
        const result = [];

        lines.forEach(line => {
            line = line.trim();
            if (!line) return;

            let charsData = [];
            let i = 0;
            
            while (i < line.length) {
                let char = line[i];
                if (char === '*' || char === '(' || char === ')') { i++; continue; }

                let customPinyin = null;
                let isHint = false;
                let nextIdx = i + 1;

                if (nextIdx < line.length && line[nextIdx] === '(') {
                    let endIdx = line.indexOf(')', nextIdx);
                    if (endIdx !== -1) {
                        customPinyin = line.substring(nextIdx + 1, endIdx);
                        nextIdx = endIdx + 1;
                    }
                }

                if (nextIdx < line.length && line[nextIdx] === '*') {
                    isHint = true;
                    nextIdx++;
                }

                charsData.push({ char, pinyin: customPinyin, isHint });
                i = nextIdx;
            }

            let pureText = charsData.map(item => item.char).join('');
            let autoPinyins = pinyin(pureText, { type: 'array' });

            charsData.forEach((item, idx) => {
                if (!item.pinyin) item.pinyin = autoPinyins[idx] || ''; 
            });

            if (charsData.length > 0) result.push(charsData);
        });
        
        return result;
    }

    // åˆ›å»ºæ–°é¡µé¢
    function createNewSheet() {
        const sheet = document.createElement('div');
        sheet.className = 'sheet';
        const title = document.getElementById('docTitle').value;
        const showAnswer = document.getElementById('showAnswer').checked;
        
        let metaHTML = '';
        if (showAnswer) {
            metaHTML = `<div class="meta-item" style="color:#ef4444; font-weight:bold; border: 1px solid #ef4444; padding: 2px 10px; border-radius: 4px;">æœ¬é¡µä¸ºç­”æ¡ˆå‚è€ƒ</div>`;
        } else {
            if(document.getElementById('showClass').checked) metaHTML += `<div class="meta-item">ç­çº§ï¼š<span></span></div>`;
            if(document.getElementById('showName').checked) metaHTML += `<div class="meta-item">å§“åï¼š<span></span></div>`;
            if(document.getElementById('showScore').checked) metaHTML += `<div class="meta-item">å¾—åˆ†ï¼š<span></span></div>`;
        }

        sheet.innerHTML = `
            <div class="sheet-header">
                <div class="sheet-title">${title}</div>
                <div class="sheet-meta">${metaHTML}</div>
            </div>
            <div class="sheet-content"></div>
        `;
        return sheet;
    }

    // æ¸²æŸ“å‡½æ•°
    function render() {
        const previewArea = document.getElementById('previewArea');
        previewArea.innerHTML = ''; 
        
        const wordData = parseInput(document.getElementById('wordInput').value);
        const gridType = document.querySelector('input[name="gridType"]:checked').value;
        const showAnswer = document.getElementById('showAnswer').checked;
        const bgClass = gridType === 'tian' ? 'bg-tian' : 'bg-mi';

        let currentSheet = createNewSheet();
        previewArea.appendChild(currentSheet);
        let contentArea = currentSheet.querySelector('.sheet-content');

        wordData.forEach(wordGroup => {
            const wordBlock = document.createElement('div');
            wordBlock.className = 'word-block';

            wordGroup.forEach(item => {
                const unit = document.createElement('div');
                unit.className = 'char-unit';
                
                let hanziClass = '';
                let displayChar = '';
                
                if (item.isHint) {
                    hanziClass = 'hanzi-trace';
                    displayChar = item.char;
                } else if (showAnswer) {
                    hanziClass = 'hanzi-answer';
                    displayChar = item.char;
                }

                unit.innerHTML = `
                    <div class="pinyin-box">${item.pinyin}</div>
                    <div class="grid-box ${bgClass}">
                        ${displayChar ? `<div class="hanzi-content ${hanziClass}">${displayChar}</div>` : ''}
                    </div>
                `;
                wordBlock.appendChild(unit);
            });

            contentArea.appendChild(wordBlock);

            // æº¢å‡ºæ£€æµ‹é€»è¾‘
            if (contentArea.scrollHeight > contentArea.clientHeight + 2) { 
                contentArea.removeChild(wordBlock); 
                currentSheet = createNewSheet();
                previewArea.appendChild(currentSheet);
                contentArea = currentSheet.querySelector('.sheet-content');
                contentArea.appendChild(wordBlock);
            }
        });
    }

    window.onload = () => {
        switchUnit(); // åˆå§‹åŒ–æ—¶ä¼šåº”ç”¨é»˜è®¤çš„ px è®¾ç½®å¹¶æ¸²æŸ“
    };
</script>
</body>
</html>
