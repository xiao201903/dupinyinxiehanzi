<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±‰å­—è½¬æ‹¼éŸ³å­—å¸–ç”Ÿæˆå™¨ - æ™ºèƒ½ç‰ˆ</title>
    <script src="https://unpkg.com/pinyin-pro"></script>
    <link href="https://fonts.googleapis.com/css2?family=Andika&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* --- å­—å¸–å‚æ•° --- */
            --grid-size: 18mm;
            --p-top: 20mm; --p-bottom: 20mm; --p-left: 20mm; --p-right: 20mm;
            --row-gap: 12mm;
            --grid-color: #d32f2f;
            /* å­—ä½“ï¼šæ•™æä½“ -> æ¥·ä½“ */
            --pinyin-font: 'Andika', "STKaiti", "KaiTi", "æ¥·ä½“", serif;
            --hanzi-font: "æ¥·ä½“", "STKaiti", "KaiTi", serif;

            /* --- UI é¢œè‰² --- */
            --primary-color: #059669; /* ç¿¡ç¿ ç»¿ï¼ŒæŠ¤çœ¼ä¸”ä¸“ä¸š */
            --bg-color: #f0fdf4;
            --border-color: #d1fae5;
        }
        
        body { margin: 0; background: var(--bg-color); font-family: 'Noto Sans SC', sans-serif; display: flex; color: #333; height: 100vh; overflow: hidden; }
        
        /* å·¦ä¾§é¢„è§ˆåŒº */
        #viewport { flex-grow: 1; height: 100%; overflow-y: auto; padding: 40px 20px; display: flex; flex-direction: column; align-items: center; box-sizing: border-box; }

        .page {
            width: 210mm; height: 297mm;
            padding: var(--p-top) var(--p-right) var(--p-bottom) var(--p-left);
            background: #fff; box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            box-sizing: border-box; display: flex; flex-direction: column; 
            position: relative; page-break-after: always; margin-bottom: 40px;
            flex-shrink: 0; /* é˜²æ­¢é¡µé¢è¢«å‹ç¼© */
        }

        .page-header-title { text-align: center; font-size: 26px; font-weight: 700; color: #111; margin-bottom: 8mm; letter-spacing: 4px; }

        .info-bar {
            display: flex; justify-content: space-between; font-size: 14px; color: #555;
            border-bottom: 1.5px dashed var(--grid-color); padding-bottom: 8px; margin-bottom: 10mm;
        }
        
        .render-area { display: flex; flex-wrap: wrap; gap: var(--row-gap) 6mm; align-content: flex-start; flex-grow: 1; }

        .page-footer { position: absolute; bottom: 12mm; left: 0; right: 0; text-align: center; font-size: 12px; color: #999; counter-increment: pageCounter; }
        .page-footer::after { content: "- ç¬¬ " counter(pageCounter) " é¡µ -"; }

        .word-group { display: flex; break-inside: avoid; gap: 0; }
        
        .char-unit { display: flex; flex-direction: column; align-items: center; position: relative; }

        /* æ‹¼éŸ³å±‚ */
        .pinyin { 
            height: 11mm; font-family: var(--pinyin-font); font-size: 18pt; 
            color: #222; margin-bottom: 2mm; display: flex; align-items: flex-end; justify-content: center;
            width: 100%; font-variant-ligatures: none;
        }

        /* æ±‰å­—æçº¢å±‚ (é»˜è®¤éšè—ï¼Œå¯å¼€å¯) */
        .hanzi-overlay {
            position: absolute; bottom: 0; width: var(--grid-size); height: var(--grid-size);
            font-family: var(--hanzi-font); font-size: calc(var(--grid-size) * 0.8);
            line-height: var(--grid-size); text-align: center;
            color: rgba(0,0,0,0.15); /* æµ…ç°è‰²æçº¢ */
            pointer-events: none; z-index: 1; display: none;
        }
        .show-hanzi .hanzi-overlay { display: block; }

        /* ç”°å­—æ ¼ */
        .tian-zi-ge { 
            width: var(--grid-size); height: var(--grid-size); 
            border: 2px solid var(--grid-color);
            position: relative; box-sizing: border-box; margin-left: -2px; z-index: 0;
        }
        .char-unit:first-child .tian-zi-ge { margin-left: 0; }
        .type-tian {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100%25' height='100%25'%3E%3Cline x1='50%25' y1='0' x2='50%25' y2='100%25' stroke='%23d32f2f' stroke-width='1' stroke-dasharray='5,4'/%3E%3Cline x1='0' y1='50%25' x2='100%25' y2='50%25' stroke='%23d32f2f' stroke-width='1' stroke-dasharray='5,4'/%3E%3C/svg%3E");
        }

        /* å³ä¾§æ§åˆ¶é¢æ¿ */
        .panel {
            width: 350px; height: 100vh; background: #fff; border-left: 1px solid #e5e7eb;
            display: flex; flex-direction: column; position: sticky; top: 0; box-shadow: -5px 0 15px rgba(0,0,0,0.03);
        }
        .panel-content { padding: 25px; overflow-y: auto; flex-grow: 1; }

        h2 { font-size: 18px; color: #065f46; margin: 0 0 20px 0; display: flex; align-items: center; gap: 8px; font-weight: 700; }
        
        .control-group { margin-bottom: 20px; }
        .label { display: block; font-size: 13px; color: #666; margin-bottom: 6px; font-weight: 500; }
        
        textarea, input[type="text"] {
            width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid #d1d5db; 
            border-radius: 8px; font-size: 14px; transition: 0.2s; background: #f9fafb;
        }
        textarea:focus, input:focus { border-color: var(--primary-color); outline: none; background: #fff; box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1); }
        
        .toggle-row { display: flex; align-items: center; gap: 10px; margin-top: 5px; cursor: pointer; }
        .toggle-row input { margin: 0; }
        .toggle-row span { font-size: 13px; color: #444; }

        .btn-print {
            width: 100%; padding: 14px; background: var(--primary-color); color: white; border: none;
            border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.2s;
        }
        .btn-print:hover { background: #047857; }

        @media print {
            .no-print { display: none !important; }
            body { background: white; height: auto; overflow: visible; }
            #viewport { padding: 0; height: auto; display: block; }
            .page { margin: 0; box-shadow: none; width: 210mm; height: 297mm; page-break-after: always; }
        }
    </style>
</head>
<body>

<div id="viewport">
    <div id="content"></div>
</div>

<div class="panel no-print">
    <div class="panel-content">
        <h2>âœ¨ æ™ºèƒ½å­—å¸–é…ç½®</h2>
        
        <div class="control-group">
            <label class="label">å­—å¸–æ ‡é¢˜</label>
            <input type="text" id="titleInput" value="çœ‹æ‹¼éŸ³å†™æ±‰å­—" oninput="render()">
        </div>

        <div class="control-group">
            <label class="label">è¾“å…¥æ±‰å­— (è‡ªåŠ¨è½¬æ‹¼éŸ³)</label>
            <textarea id="input" rows="6" oninput="render()" placeholder="åœ¨æ­¤è¾“å…¥æ±‰å­—ï¼Œä¾‹å¦‚ï¼šä½ å¥½ä¸–ç•Œ...">æ˜¥çœ ä¸è§‰æ™“ï¼Œå¤„å¤„é—»å•¼é¸Ÿã€‚
å¤œæ¥é£é›¨å£°ï¼ŒèŠ±è½çŸ¥å¤šå°‘ã€‚</textarea>
        </div>

        <div class="control-group">
            <label class="toggle-row">
                <input type="checkbox" id="showHanzi" onchange="render()">
                <span>æ˜¾ç¤ºæçº¢æ±‰å­— (é€‚åˆä½é¾„)</span>
            </label>
        </div>

        <div class="control-group">
            <label class="label">æ ¼å­å¤§å°: <span id="sizeVal">18mm</span></label>
            <input type="range" id="size" min="15" max="30" value="18" step="1" oninput="updateStyle()" style="width:100%">
        </div>
        
        <div class="control-group">
            <label class="label">ä¸»é¢˜é¢œè‰²</label>
            <input type="color" id="color" value="#d32f2f" oninput="updateStyle()" style="width:100%; height:40px; padding:2px;">
        </div>

        <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ ç«‹å³æ‰“å°</button>
    </div>
</div>

<script>
    const { pinyin } = pinyinPro;

    function updateStyle() {
        const root = document.documentElement;
        const size = document.getElementById('size').value;
        const color = document.getElementById('color').value;

        document.getElementById('sizeVal').innerText = size + 'mm';
        root.style.setProperty('--grid-size', size + 'mm');
        root.style.setProperty('--grid-color', color);

        // åŠ¨æ€æ›´æ–°SVGé¢œè‰²
        const svgColor = encodeURIComponent(color);
        const newBg = `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100%25' height='100%25'%3E%3Cline x1='50%25' y1='0' x2='50%25' y2='100%25' stroke='${svgColor}' stroke-width='1' stroke-dasharray='5,4'/%3E%3Cline x1='0' y1='50%25' x2='100%25' y2='50%25' stroke='${svgColor}' stroke-width='1' stroke-dasharray='5,4'/%3E%3C/svg%3E")`;
        
        let styleTag = document.getElementById('dynamic-svg');
        if (!styleTag) {
            styleTag = document.createElement('style');
            styleTag.id = 'dynamic-svg';
            document.head.appendChild(styleTag);
        }
        styleTag.innerHTML = `.type-tian { background-image: ${newBg} !important; }`;
    }

    function createPage(titleText) {
        const div = document.createElement('div');
        div.className = 'page';
        div.innerHTML = `
            <div class="page-header-title">${titleText}</div>
            <div class="info-bar">
                <span>å§“åï¼š__________</span>
                <span>æ—¥æœŸï¼š__________</span>
                <span>å¾—åˆ†ï¼š__________</span>
            </div>
            <div class="render-area"></div>
            <div class="page-footer"></div>
        `;
        return div;
    }

    function render() {
        const content = document.getElementById('content');
        const rawInput = document.getElementById('input').value;
        const title = document.getElementById('titleInput').value;
        const showHanzi = document.getElementById('showHanzi').checked;
        
        content.innerHTML = '';
        let page = createPage(title);
        content.appendChild(page);
        let area = page.querySelector('.render-area');

        // 1. æŒ‰æ ‡ç‚¹ç¬¦å·æˆ–æ¢è¡Œç¬¦åˆ†å‰²æˆè¯ç»„ï¼Œä¿ç•™åˆ†å‰²ç»“æ„
        // ä½¿ç”¨æ­£åˆ™å°†æ–‡æœ¬æŒ‰ [é€—å·, å¥å·, æ¢è¡Œ, ç©ºæ ¼] åˆ†å‰²ï¼Œä½†ä¿ç•™å†…å®¹
        const segments = rawInput.split(/([,ï¼Œ.ã€‚\n\r\s]+)/);

        segments.forEach(segment => {
            if (!segment) return;

            // å¦‚æœæ˜¯æ ‡ç‚¹ç¬¦å·æˆ–ç©ºç™½ï¼Œä¸ä»…è·³è¿‡æ¸²æŸ“ï¼Œå¦‚æœæ˜¯æ¢è¡Œç¬¦è¿˜å¯ä»¥è€ƒè™‘æ¢è¡Œ(è¿™é‡Œæš‚åšç®€å•å¤„ç†ï¼šè§†ä¸ºç©ºç™½åˆ†éš”)
            if (/^[,ï¼Œ.ã€‚\n\r\s]+$/.test(segment)) {
                return; 
            }

            // 2. å°†æ±‰å­—è½¬æ¢ä¸ºæ‹¼éŸ³å¯¹è±¡æ•°ç»„
            // pinyin-pro æ ¸å¿ƒè°ƒç”¨ï¼štype: 'array' è¿”å›æ•°ç»„
            const pinyinArr = pinyin(segment, { type: 'array', toneType: 'symbol' });
            const hanziArr = segment.split('');

            const group = document.createElement('div');
            group.className = 'word-group';

            hanziArr.forEach((char, index) => {
                // è¿‡æ»¤æ‰æ— æ³•è½¬æ‹¼éŸ³çš„ç‰¹æ®Šå­—ç¬¦ï¼ˆé˜²æ­¢ä¹±ç æ¡†ï¼‰
                if (!pinyinArr[index]) return;

                const unit = document.createElement('div');
                unit.className = 'char-unit';
                if (showHanzi) unit.classList.add('show-hanzi');

                unit.innerHTML = `
                    <div class="pinyin">${pinyinArr[index]}</div>
                    <div class="tian-zi-ge type-tian">
                        <div class="hanzi-overlay">${char}</div>
                    </div>
                `;
                group.appendChild(unit);
            });

            area.appendChild(group);

            // è‡ªåŠ¨åˆ†é¡µé€»è¾‘
            if (area.scrollHeight > area.clientHeight + 5) {
                // å¦‚æœå½“å‰ç»„æ”¾ä¸ä¸‹ï¼Œå…ˆæŠŠå½“å‰ç»„ç§»é™¤
                area.removeChild(group);
                // æ–°å»ºä¸€é¡µ
                page = createPage(title);
                content.appendChild(page);
                area = page.querySelector('.render-area');
                // åœ¨æ–°é¡µæ”¾å…¥è¯¥ç»„
                area.appendChild(group);
            }
        });
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        updateStyle();
        render();
    });
</script>
</body>
</html>
