<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ä¸“ä¸šçœ‹æ‹¼éŸ³å†™è¯è¯­ç”Ÿæˆå™¨ - å¢å¼ºç‰ˆ</title>
    <script src="https://unpkg.com/pinyin-pro"></script>
    <link href="https://fonts.googleapis.com/css2?family=Andika&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3b82f6;
            --grid-size: 65px;
            --grid-color: #d32f2f;
            --pinyin-size: 24px;
            --hanzi-size: 38px;
            --row-gap: 25px;
            --word-gap: 30px;
        }

        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { margin: 0; background: #f1f5f9; font-family: 'Noto Sans SC', sans-serif; display: flex; height: 100vh; overflow: hidden; }

        /* å·¦ä¾§é…ç½®é¢æ¿ */
        .sidebar { width: 380px; background: white; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; box-shadow: 2px 0 10px rgba(0,0,0,0.05); z-index: 10; }
        .config-scroll { padding: 20px; overflow-y: auto; flex: 1; }
        .control-group { margin-bottom: 24px; border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; }
        .group-title { font-size: 15px; font-weight: 700; color: #1e293b; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        
        .item-label { display: block; font-size: 13px; color: #64748b; margin: 10px 0 5px; }
        input[type="text"], textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; outline: none; }
        textarea { resize: vertical; }
        .slider-box { display: flex; align-items: center; gap: 10px; margin: 8px 0; }
        input[type="range"] { flex: 1; accent-color: var(--primary); }
        .val-tag { min-width: 45px; font-size: 12px; color: var(--primary); font-weight: bold; }

        .check-group { display: flex; flex-wrap: wrap; gap: 12px; margin: 10px 0; }
        .check-item { display: flex; align-items: center; gap: 5px; font-size: 13px; cursor: pointer; }

        /* å³ä¾§é¢„è§ˆåŒº */
        .preview-area { flex: 1; background: #94a3b8; overflow: auto; padding: 40px; display: flex; flex-direction: column; align-items: center; gap: 20px; }
        
        /* A4 é¡µé¢è®¾ç½® */
        .sheet { 
            width: 210mm; 
            min-height: 297mm; 
            background: white; 
            padding: 15mm 15mm 20mm; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            flex-shrink: 0;
            box-sizing: border-box;
            page-break-after: always;
        }

        .sheet-header { text-align: center; margin-bottom: 8mm; }
        .sheet-title { font-size: 28px; font-weight: bold; margin-bottom: 4mm; }
        .sheet-meta { display: flex; justify-content: center; gap: 10mm; font-size: 14px; }
        .meta-item span { border-bottom: 1px solid #000; padding: 0 15px; min-width: 80px; display: inline-block; }

        .sheet-content { 
            display: flex; 
            flex-wrap: wrap; 
            align-content: flex-start; 
            row-gap: var(--row-gap); 
            column-gap: var(--word-gap); 
        }

        /* å•è¯ä¸æ ¼å­ */
        .word-block { display: flex; break-inside: avoid; }
        .char-unit { display: flex; flex-direction: column; align-items: center; }
        .pinyin-box { height: 35px; font-family: 'Andika', sans-serif; font-size: var(--pinyin-size); color: #333; display: flex; align-items: flex-end; justify-content: center; width: 100%; }
        .grid-box { width: var(--grid-size); height: var(--grid-size); border: 1px solid var(--grid-color); position: relative; margin-left: -1px; display: flex; justify-content: center; align-items: center; }
        .char-unit:first-child .grid-box { margin-left: 0; }

        /* æ±‰å­—æ ·å¼ */
        .hanzi-content { font-family: "æ¥·ä½“", "KaiTi", serif; font-size: var(--hanzi-size); color: #333; position: absolute; }
        .hanzi-answer { color: #e2e8f0 !important; } /* ç­”æ¡ˆæ¨¡å¼ï¼šæµ…ç°è‰² */

        /* æ ¼çº¿èƒŒæ™¯ */
        .bg-tian { background-image: url("data:image/svg+xml,%3Csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3E%3Cline x1='50%25' y1='0' x2='50%25' y2='100%25' stroke='%23d32f2f' stroke-width='0.5' stroke-dasharray='3,3'/%3E%3Cline x1='0' y1='50%25' x2='100%25' y2='50%25' stroke='%23d32f2f' stroke-width='0.5' stroke-dasharray='3,3'/%3E%3C/svg%3E"); }
        .bg-mi { background-image: url("data:image/svg+xml,%3Csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3E%3Cline x1='50%25' y1='0' x2='50%25' y2='100%25' stroke='%23d32f2f' stroke-width='0.5' stroke-dasharray='3,3'/%3E%3Cline x1='0' y1='50%25' x2='100%25' y2='50%25' stroke='%23d32f2f' stroke-width='0.5' stroke-dasharray='3,3'/%3E%3Cline x1='0' y1='0' x2='100%25' y2='100%25' stroke='%23d32f2f' stroke-width='0.5' stroke-dasharray='3,3'/%3E%3Cline x1='100%25' y1='0' x2='0' y2='100%25' stroke='%23d32f2f' stroke-width='0.5' stroke-dasharray='3,3'/%3E%3C/svg%3E"); }

        .btn-export { width: 100%; padding: 15px; background: #f59e0b; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; }
        .tips { font-size: 12px; color: #94a3b8; line-height: 1.5; margin-top: 5px; }

        @media print {
            body { background: white; overflow: visible; }
            .sidebar { display: none; }
            .preview-area { padding: 0; background: white; overflow: visible; display: block; }
            .sheet { margin: 0; box-shadow: none; border: none; }
        }
    </style>
</head>
<body>

<aside class="sidebar">
    <div class="config-scroll">
        <div class="group-title">ğŸ·ï¸ æ ‡é¢˜è®¾ç½®</div>
        <input type="text" id="docTitle" value="çœ‹æ‹¼éŸ³å†™è¯è¯­ç»ƒä¹ " oninput="render()">
        
        <div class="group-title" style="margin-top:20px;">ğŸ“ è¯è¯­å½•å…¥</div>
        <textarea id="wordInput" rows="8" oninput="render()" placeholder="è¾“å…¥è¯è¯­...">æ—©ä¸Š*&#10;ç»ƒä¹ &#10;é‡è¦(zhÃ²ng yÃ o)&#10;ä¹(yuÃ¨)å™¨</textarea>
        <div class="tips">
            * æŠ€å·§ï¼š<br>
            1. å­—ååŠ  * è¡¨ç¤ºæ˜¾ç¤ºè¯¥æ±‰å­—(æçº¢)<br>
            2. æ‹¬å·æŒ‡å®šæ‹¼éŸ³ï¼šé‡(zhÃ²ng)é‡<br>
            3. è‡ªåŠ¨åˆ†é¡µï¼Œå¯è¾“å…¥å¤§é‡å†…å®¹
        </div>
        
        <div class="group-title" style="margin-top:20px;">âš™ï¸ åŠŸèƒ½æ§åˆ¶</div>
        <div class="check-group">
            <label class="check-item"><input type="checkbox" id="showAnswer" onchange="render()"> ğŸ’¡ æ˜¾ç¤ºç­”æ¡ˆæ¨¡å¼</label>
        </div>

        <div class="group-title" style="margin-top:10px;">ğŸ“Š æ ¼å¼è®¾ç½®</div>
        <span class="item-label">æ ¼çº¿ç±»å‹</span>
        <div class="check-group">
            <label class="check-item"><input type="radio" name="gridType" value="tian" checked onchange="render()"> ç”°å­—æ ¼</label>
            <label class="check-item"><input type="radio" name="gridType" value="mi" onchange="render()"> ç±³å­—æ ¼</label>
        </div>

        <span class="item-label">æ ¼å­å¤§å°: <span id="sizeVal" class="val-tag">65px</span></span>
        <input type="range" id="sizeRange" min="40" max="100" value="65" oninput="updateStyles()">

        <span class="item-label">è¡Œé—´è·: <span id="rowGapVal" class="val-tag">25px</span></span>
        <input type="range" id="rowGapRange" min="10" max="80" value="25" oninput="updateStyles()">

        <span class="item-label">æ‹¼éŸ³/æ±‰å­—å¤§å°</span>
        <div class="slider-box">
            <input type="range" id="pySizeRange" min="12" max="40" value="24" oninput="updateStyles()">
            <input type="range" id="hzSizeRange" min="20" max="80" value="38" oninput="updateStyles()">
        </div>

        <button class="btn-export" onclick="window.print()">ğŸ“¥ å¯¼å‡º PDF / æ‰“å°</button>
    </div>
</aside>

<main class="preview-area" id="previewArea"></main>

<script>
    const { pinyin } = pinyinPro;

    function updateStyles() {
        const root = document.documentElement;
        const size = document.getElementById('sizeRange').value;
        const rowGap = document.getElementById('rowGapRange').value;
        const pySize = document.getElementById('pySizeRange').value;
        const hzSize = document.getElementById('hzSizeRange').value;

        document.getElementById('sizeVal').innerText = size + 'px';
        document.getElementById('rowGapVal').innerText = rowGap + 'px';

        root.style.setProperty('--grid-size', size + 'px');
        root.style.setProperty('--row-gap', rowGap + 'px');
        root.style.setProperty('--pinyin-size', pySize + 'px');
        root.style.setProperty('--hanzi-size', hzSize + 'px');
        
        // æ¸²æŸ“æ—¶éœ€è¦é‡æ–°è®¡ç®—åˆ†é¡µ
        render(); 
    }

    // è§£æè¾“å…¥æ–‡æœ¬ï¼Œæ”¯æŒ "ä¹(yuÃ¨)å™¨" æˆ– "æ—©ä¸Š*" è¯­æ³•
    function parseInput(text) {
        const lines = text.split('\n').map(l => l.trim()).filter(l => l);
        const result = [];

        lines.forEach(line => {
            let chars = [];
            // æ­£åˆ™åŒ¹é…ï¼šæ±‰å­— + (å¯é€‰æ‹¬å·æ‹¼éŸ³) + (å¯é€‰æ˜Ÿå·)
            const regex = /([\u4e00-\u9fa5])(?:\(([^)]+)\))?(\*)?/g;
            let match;
            
            while ((match = regex.exec(line)) !== null) {
                chars.push({
                    char: match[1],
                    customPinyin: match[2] || null,
                    isHint: !!match[3]
                });
            }

            // å¦‚æœæ²¡åŒ¹é…åˆ°ï¼ˆæ¯”å¦‚çº¯æ±‰å­—è¾“å…¥ï¼‰ï¼Œé™çº§å¤„ç†
            if (chars.length === 0 && line.length > 0) {
                const pureText = line.replace(/\*/g, '');
                const pinyins = pinyin(pureText, { type: 'array' });
                line.split('').forEach((c, i) => {
                    if(c === '*') return;
                    result.push({ char: c, pinyin: pinyins[i], isHint: line[i+1] === '*' });
                });
            } else {
                chars.forEach(item => {
                    item.pinyin = item.customPinyin || pinyin(item.char, { toneType: 'symbol' });
                });
                result.push(chars);
            }
        });
        return result;
    }

    function createNewSheet(title) {
        const sheet = document.createElement('div');
        sheet.className = 'sheet';
        
        let metaHTML = '';
        if(document.getElementById('showAnswer').checked) {
            metaHTML = `<div class="meta-item" style="color:red; font-weight:bold;">ã€ç­”æ¡ˆé¡µã€‘</div>`;
        } else {
            metaHTML = `
                <div class="meta-item">ç­çº§ï¼š<span></span></div>
                <div class="meta-item">å§“åï¼š<span></span></div>
                <div class="meta-item">å¾—åˆ†ï¼š<span></span></div>
            `;
        }

        sheet.innerHTML = `
            <div class="sheet-header">
                <div class="sheet-title">${title}</div>
                <div class="sheet-meta">${metaHTML}</div>
            </div>
            <div class="sheet-content"></div>
        `;
        return sheet;
    }

    function render() {
        const previewArea = document.getElementById('previewArea');
        previewArea.innerHTML = '';
        
        const title = document.getElementById('docTitle').value;
        const wordData = parseInput(document.getElementById('wordInput').value);
        const gridType = document.querySelector('input[name="gridType"]:checked').value;
        const showAnswer = document.getElementById('showAnswer').checked;
        const bgClass = gridType === 'tian' ? 'bg-tian' : 'bg-mi';

        let currentSheet = createNewSheet(title);
        previewArea.appendChild(currentSheet);
        let currentContent = currentSheet.querySelector('.sheet-content');

        // A4 çº¸å¼ å¯ç”¨é«˜åº¦ (297mm - ä¸Šä¸‹è¾¹è·) çº¦ 260mm
        // åœ¨ç½‘é¡µç«¯ç”¨åƒç´ ä¼°ç®—ï¼Œçº¦ 950px - 1000px
        const maxHeight = 960; 

        wordData.forEach(wordGroup => {
            const wordBlock = document.createElement('div');
            wordBlock.className = 'word-block';

            wordGroup.forEach(item => {
                const unit = document.createElement('div');
                unit.className = 'char-unit';
                
                // ç­”æ¡ˆæ¨¡å¼é€»è¾‘ï¼šå¦‚æœæ˜¯æç¤ºå­—ï¼Œæ­£å¸¸æ˜¾ç¤ºï¼›å¦‚æœä¸æ˜¯æç¤ºå­—ä½†å¼€å¯äº†ç­”æ¡ˆæ¨¡å¼ï¼Œæ˜¾ç¤ºæµ…è‰²å­—
                let hanziHtml = '';
                if (item.isHint) {
                    hanziHtml = `<div class="hanzi-content">${item.char}</div>`;
                } else if (showAnswer) {
                    hanziHtml = `<div class="hanzi-content hanzi-answer">${item.char}</div>`;
                }

                unit.innerHTML = `
                    <div class="pinyin-box">${item.pinyin}</div>
                    <div class="grid-box ${bgClass}">${hanziHtml}</div>
                `;
                wordBlock.appendChild(unit);
            });

            currentContent.appendChild(wordBlock);

            // æ£€æµ‹æ˜¯å¦æº¢å‡º
            if (currentSheet.scrollHeight > maxHeight) {
                // å¦‚æœå½“å‰è¯å—å¯¼è‡´æº¢å‡ºï¼Œç§»åˆ°ä¸‹ä¸€é¡µ
                currentContent.removeChild(wordBlock);
                currentSheet = createNewSheet(title);
                previewArea.appendChild(currentSheet);
                currentContent = currentSheet.querySelector('.sheet-content');
                currentContent.appendChild(wordBlock);
            }
        });
    }

    window.onload = () => {
        render();
    }
</script>
</body>
</html>
