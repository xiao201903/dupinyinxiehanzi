<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœ‹æ‹¼éŸ³å†™è¯è¯­ç”Ÿæˆå·¥å…· - ä¸“ä¸šç‰ˆ</title>
    <script src="https://unpkg.com/pinyin-pro"></script>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #3b82f6; /* ç§‘æŠ€è“ */
            --bg-panel: #ffffff;
            --bg-body: #f1f5f9;
            --border: #e2e8f0;
            --text-main: #334155;
            
            /* å­—å¸–åŠ¨æ€å‚æ•° */
            --grid-size: 60px; /* é»˜è®¤åƒç´ å€¼ï¼Œæ‰“å°æ—¶ä¼šæ¢ç®— */
            --grid-color: #333;
            --pinyin-size: 18px;
            --hanzi-size: 40px;
        }

        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; background: var(--bg-body); font-family: 'Noto Sans SC', sans-serif; color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

        /* --- å·¦ä¾§æ§åˆ¶é¢æ¿ (Sidebar) --- */
        .sidebar {
            width: 380px; background: var(--bg-panel); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; height: 100%; box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            z-index: 10;
        }
        
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); background: #fff; }
        .app-title { font-size: 18px; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 8px; }
        .app-title::before { content: 'ğŸ“'; }

        .config-scroll { padding: 20px; overflow-y: auto; flex: 1; }

        .control-group { margin-bottom: 24px; }
        .group-title { font-size: 14px; font-weight: 600; color: #64748b; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
        .group-title::before { content: ''; width: 4px; height: 14px; background: var(--primary); border-radius: 2px; }

        /* è¾“å…¥æ§ä»¶æ ·å¼ */
        .input-wrapper { display: flex; flex-direction: column; gap: 8px; }
        label { font-size: 13px; color: #475569; }
        
        input[type="text"], textarea, select {
            width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;
            font-size: 14px; transition: 0.2s; background: #f8fafc;
        }
        input:focus, textarea:focus { border-color: var(--primary); outline: none; background: #fff; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        
        /* èŒƒå›´æ»‘å— */
        .slider-row { display: flex; align-items: center; gap: 10px; font-size: 12px; }
        input[type="range"] { flex: 1; accent-color: var(--primary); }

        /* é€‰é¡¹å¡/å•é€‰ */
        .radio-group { display: flex; gap: 10px; }
        .radio-label { display: flex; align-items: center; gap: 6px; font-size: 13px; cursor: pointer; }

        /* æŒ‰é’® */
        .btn-action {
            width: 100%; padding: 12px; background: var(--primary); color: white; border: none;
            border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s;
            display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 10px;
        }
        .btn-action:hover { background-color: #2563eb; }

        /* --- å³ä¾§é¢„è§ˆåŒº (Preview) --- */
        .preview-area {
            flex: 1; background: #cbd5e1; overflow: auto; padding: 40px;
            display: flex; flex-direction: column; align-items: center;
        }

        /* A4 çº¸å¼ æ¨¡æ‹Ÿ */
        .sheet {
            width: 210mm; height: 297mm; background: white; 
            padding: 15mm; /* é»˜è®¤é¡µè¾¹è· */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 30px; position: relative; display: flex; flex-direction: column;
            flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
        }

        /* çº¸å¼ å†…éƒ¨å¸ƒå±€ */
        .sheet-header { text-align: center; margin-bottom: 10mm; }
        .sheet-title { font-size: 24px; font-weight: bold; margin-bottom: 5mm; letter-spacing: 2px; }
        .sheet-meta { 
            display: flex; justify-content: center; gap: 15mm; font-size: 14px; color: #555;
            border-bottom: 1px solid transparent; /* å ä½ */
        }
        .sheet-meta input { 
            border: none; border-bottom: 1px solid #333; border-radius: 0; background: transparent; 
            width: 60px; text-align: center; padding: 0 5px; font-family: inherit;
        }

        .sheet-content { 
            flex: 1; display: flex; flex-wrap: wrap; align-content: flex-start; 
            gap: 10px; /* é»˜è®¤è¡Œè· */
        }
        
        /* è¯è¯­ç»„ï¼ˆä¸æ¢è¡Œå•ä½ï¼‰ */
        .word-block { display: flex; margin-right: 15px; margin-bottom: 15px; break-inside: avoid; }

        /* å•ä¸ªå­—å•å…ƒ */
        .char-unit { display: flex; flex-direction: column; align-items: center; }
        
        .pinyin-box {
            height: 24px; width: 100%; display: flex; align-items: flex-end; justify-content: center;
            font-family: 'Andika', sans-serif; font-size: var(--pinyin-size); color: #444;
            letter-spacing: 1px;
        }

        .grid-box {
            width: var(--grid-size); height: var(--grid-size);
            border: 2px solid var(--grid-color);
            position: relative; margin-left: -2px; /* é‡å è¾¹æ¡† */
            display: flex; justify-content: center; align-items: center;
        }
        .char-unit:first-child .grid-box { margin-left: 0; }

        /* æ±‰å­—æ˜¾ç¤º */
        .hanzi-content {
            font-family: "KaiTi", "æ¥·ä½“", serif;
            font-size: var(--hanzi-size);
            color: #222; z-index: 2; line-height: 1;
            pointer-events: none; /* è®©é¼ æ ‡èƒ½ç©¿é€å»ç‚¹å‡»æ ¼å­(å¦‚æœéœ€è¦äº¤äº’) */
        }
        /* éšè—æ±‰å­— */
        .hanzi-hidden { display: none; }
        /* æµ…è‰²æçº¢ */
        .hanzi-trace { color: rgba(0,0,0,0.2); }

        /* åŠ¨æ€ç”Ÿæˆçš„èƒŒæ™¯ç½‘æ ¼ (SVG) */
        .bg-tian { background-image: url("data:image/svg+xml,%3Csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3E%3Cline x1='50%25' y1='0' x2='50%25' y2='100%25' stroke='%23d32f2f' stroke-width='1' stroke-dasharray='4,4' opacity='0.5'/%3E%3Cline x1='0' y1='50%25' x2='100%25' y2='50%25' stroke='%23d32f2f' stroke-width='1' stroke-dasharray='4,4' opacity='0.5'/%3E%3C/svg%3E"); }
        
        .bg-mi { background-image: url("data:image/svg+xml,%3Csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3E%3Cline x1='50%25' y1='0' x2='50%25' y2='100%25' stroke='%23d32f2f' stroke-width='1' stroke-dasharray='4,4' opacity='0.5'/%3E%3Cline x1='0' y1='50%25' x2='100%25' y2='50%25' stroke='%23d32f2f' stroke-width='1' stroke-dasharray='4,4' opacity='0.5'/%3E%3Cline x1='0' y1='0' x2='100%25' y2='100%25' stroke='%23d32f2f' stroke-width='1' stroke-dasharray='4,4' opacity='0.5'/%3E%3Cline x1='100%25' y1='0' x2='0' y2='100%25' stroke='%23d32f2f' stroke-width='1' stroke-dasharray='4,4' opacity='0.5'/%3E%3C/svg%3E"); }

        .sheet-footer { position: absolute; bottom: 10mm; width: calc(100% - 30mm); text-align: center; font-size: 12px; color: #999; }

        /* --- æ‰“å°æ ·å¼ --- */
        @media print {
            .sidebar { display: none; }
            .preview-area { padding: 0; background: white; display: block; }
            .sheet { margin: 0; box-shadow: none; page-break-after: always; width: 210mm; height: 297mm; }
            body { overflow: visible; height: auto; }
        }
    </style>
</head>
<body>

<aside class="sidebar">
    <div class="sidebar-header">
        <div class="app-title">æ‹¼éŸ³è¯è¯­ç»ƒä¹ ç”Ÿæˆå™¨</div>
    </div>
    
    <div class="config-scroll">
        <div class="control-group">
            <div class="group-title">æ ‡é¢˜è®¾ç½®</div>
            <div class="input-wrapper">
                <input type="text" id="docTitle" value="çœ‹æ‹¼éŸ³å†™è¯è¯­ç»ƒä¹ " oninput="render()">
            </div>
        </div>

        <div class="control-group">
            <div class="group-title">è¯è¯­å½•å…¥ (æ¯è¡Œä¸€ä¸ªè¯)</div>
            <textarea id="wordInput" rows="8" oninput="render()" placeholder="ä¾‹å¦‚ï¼š
ä½ å¥½
æ‹¼éŸ³
æ±‰å­—* (æ˜¾ç¤ºæ±‰å­—)">
æ˜¥é£
ç”Ÿ*é•¿
ä»€ä¹ˆ
æ–¹*å‘*
å›½*ç‹
é’è›™
å¿ƒæƒ…
è¯·é—®</textarea>
            <p style="font-size: 12px; color: #666; margin-top: 5px;">
                ğŸ’¡ å°è´´å£«ï¼šåœ¨å­—åé¢åŠ  <b>*</b> å·ï¼Œå¯æ˜¾ç¤ºè¯¥æ±‰å­—ï¼ˆç”¨äºæçº¢æˆ–æç¤ºï¼‰ã€‚
            </p>
        </div>

        <div class="control-group">
            <div class="group-title">è¡¨å¤´æ˜¾ç¤º</div>
            <div class="radio-group">
                <label class="radio-label"><input type="checkbox" id="showClass" checked onchange="render()"> ç­çº§</label>
                <label class="radio-label"><input type="checkbox" id="showName" checked onchange="render()"> å§“å</label>
                <label class="radio-label"><input type="checkbox" id="showScore" checked onchange="render()"> å¾—åˆ†</label>
            </div>
        </div>

        <div class="control-group">
            <div class="group-title">æ ¼å­æ ·å¼</div>
            <div class="radio-group" style="margin-bottom: 15px;">
                <label class="radio-label"><input type="radio" name="gridType" value="tian" checked onchange="render()"> ç”°å­—æ ¼</label>
                <label class="radio-label"><input type="radio" name="gridType" value="mi" onchange="render()"> ç±³å­—æ ¼</label>
            </div>

            <div class="input-wrapper">
                <div class="slider-row">
                    <span>å¤§å°</span>
                    <input type="range" id="sizeRange" min="40" max="80" value="60" oninput="updateStyles()">
                    <span id="sizeVal">60px</span>
                </div>
                <div class="slider-row">
                    <span>é¢œè‰²</span>
                    <input type="color" id="colorPicker" value="#333333" oninput="updateStyles()">
                </div>
            </div>
        </div>

        <button class="btn-action" onclick="window.print()">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
            å¯¼å‡º / æ‰“å° PDF
        </button>
    </div>
</aside>

<main class="preview-area" id="previewArea">
    </main>

<script>
    const { pinyin } = pinyinPro;

    // æ›´æ–° CSS å˜é‡
    function updateStyles() {
        const root = document.documentElement;
        const size = document.getElementById('sizeRange').value;
        const color = document.getElementById('colorPicker').value;

        document.getElementById('sizeVal').innerText = size + 'px';
        
        root.style.setProperty('--grid-size', size + 'px');
        root.style.setProperty('--grid-color', color);
        // è‡ªåŠ¨è®¡ç®—å­—ä½“å¤§å°
        root.style.setProperty('--pinyin-size', (size * 0.35) + 'px');
        root.style.setProperty('--hanzi-size', (size * 0.7) + 'px');

        // æ›´æ–° SVG é¢œè‰² (éœ€è¦é‡æ–°ç”Ÿæˆ SVG å­—ç¬¦ä¸²)
        updateSvgColor(color);
    }

    function updateSvgColor(hexColor) {
        const encodedColor = encodeURIComponent(hexColor);
        // ç”°å­—æ ¼
        const tianSvg = `url("data:image/svg+xml,%3Csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3E%3Cline x1='50%25' y1='0' x2='50%25' y2='100%25' stroke='${encodedColor}' stroke-width='1' stroke-dasharray='4,4' opacity='0.5'/%3E%3Cline x1='0' y1='50%25' x2='100%25' y2='50%25' stroke='${encodedColor}' stroke-width='1' stroke-dasharray='4,4' opacity='0.5'/%3E%3C/svg%3E")`;
        // ç±³å­—æ ¼
        const miSvg = `url("data:image/svg+xml,%3Csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3E%3Cline x1='50%25' y1='0' x2='50%25' y2='100%25' stroke='${encodedColor}' stroke-width='1' stroke-dasharray='4,4' opacity='0.5'/%3E%3Cline x1='0' y1='50%25' x2='100%25' y2='50%25' stroke='${encodedColor}' stroke-width='1' stroke-dasharray='4,4' opacity='0.5'/%3E%3Cline x1='0' y1='0' x2='100%25' y2='100%25' stroke='${encodedColor}' stroke-width='1' stroke-dasharray='4,4' opacity='0.5'/%3E%3Cline x1='100%25' y1='0' x2='0' y2='100%25' stroke='${encodedColor}' stroke-width='1' stroke-dasharray='4,4' opacity='0.5'/%3E%3C/svg%3E")`;

        const styleId = 'dynamic-grid-style';
        let styleEl = document.getElementById(styleId);
        if(!styleEl) {
            styleEl = document.createElement('style');
            styleEl.id = styleId;
            document.head.appendChild(styleEl);
        }
        styleEl.innerHTML = `
            .bg-tian { background-image: ${tianSvg} !important; }
            .bg-mi { background-image: ${miSvg} !important; }
        `;
    }

    function createPage() {
        const titleText = document.getElementById('docTitle').value;
        const showClass = document.getElementById('showClass').checked;
        const showName = document.getElementById('showName').checked;
        const showScore = document.getElementById('showScore').checked;

        const page = document.createElement('div');
        page.className = 'sheet';
        
        let headerHTML = `<div class="sheet-title">${titleText}</div>`;
        if (showClass || showName || showScore) {
            headerHTML += `<div class="sheet-meta">`;
            if (showClass) headerHTML += `<div>ç­çº§ï¼š<input readonly></div>`;
            if (showName) headerHTML += `<div>å§“åï¼š<input readonly></div>`;
            if (showScore) headerHTML += `<div>å¾—åˆ†ï¼š<input readonly></div>`;
            headerHTML += `</div>`;
        }

        page.innerHTML = `
            <div class="sheet-header">${headerHTML}</div>
            <div class="sheet-content"></div>
            <div class="sheet-footer"></div>
        `;
        return page;
    }

    function render() {
        const previewArea = document.getElementById('previewArea');
        previewArea.innerHTML = ''; // æ¸…ç©º
        
        const rawInput = document.getElementById('wordInput').value;
        const lines = rawInput.split('\n'); // æŒ‰è¡Œåˆ†å‰²
        const gridType = document.querySelector('input[name="gridType"]:checked').value;
        const bgClass = gridType === 'tian' ? 'bg-tian' : 'bg-mi';

        // åˆ›å»ºç¬¬ä¸€é¡µ
        let currentPage = createPage();
        previewArea.appendChild(currentPage);
        let contentArea = currentPage.querySelector('.sheet-content');
        let pageCount = 1;

        // æ›´æ–°é¡µç 
        currentPage.querySelector('.sheet-footer').innerText = `- ç¬¬ ${pageCount} é¡µ -`;

        lines.forEach(line => {
            const trimmedLine = line.trim();
            if (!trimmedLine) return;

            // 1. å¤„ç† * å·è¯­æ³•
            // å°† "ç”Ÿ*é•¿" è§£æä¸º -> æ–‡å­— "ç”Ÿé•¿", æ©ç  [true, false]
            let cleanText = "";
            let visibilityMask = [];
            
            for (let i = 0; i < trimmedLine.length; i++) {
                const char = trimmedLine[i];
                if (char === '*') {
                    if (visibilityMask.length > 0) {
                        visibilityMask[visibilityMask.length - 1] = true; // æ ‡è®°å‰ä¸€ä¸ªå­—ä¸ºæ˜¾ç¤º
                    }
                } else {
                    cleanText += char;
                    visibilityMask.push(false); // é»˜è®¤ä¸ºéšè—
                }
            }

            // 2. ç”Ÿæˆæ‹¼éŸ³
            const pinyinArr = pinyin(cleanText, { type: 'array', toneType: 'symbol' });
            
            // 3. æ„å»º DOM å…ƒç´  (Word Block)
            const wordBlock = document.createElement('div');
            wordBlock.className = 'word-block';

            cleanText.split('').forEach((char, idx) => {
                const charUnit = document.createElement('div');
                charUnit.className = 'char-unit';
                
                // æ‹¼éŸ³
                const pyStr = pinyinArr[idx] || '';
                
                // æ±‰å­—å¯è§æ€§
                const isVisible = visibilityMask[idx];
                const hanziClass = isVisible ? 'hanzi-content' : 'hanzi-content hanzi-hidden';

                charUnit.innerHTML = `
                    <div class="pinyin-box">${pyStr}</div>
                    <div class="grid-box ${bgClass}">
                        <div class="${hanziClass}">${char}</div>
                    </div>
                `;
                wordBlock.appendChild(charUnit);
            });

            // 4. æ”¾å…¥é¡µé¢å¹¶æ£€æµ‹æº¢å‡º
            contentArea.appendChild(wordBlock);

            // ç®€å•çš„æº¢å‡ºæ£€æµ‹ (å¦‚æœé«˜åº¦è¶…è¿‡äº†å†…å®¹åŒº)
            // æ³¨æ„ï¼šè¿™ç§æ£€æµ‹åœ¨å¤§é‡æ¸²æŸ“æ—¶å¯èƒ½å¾®æŸæ€§èƒ½ï¼Œä½†å¯¹äºç”Ÿæˆå™¨æ¥è¯´å¯ä»¥æ¥å—
            if (contentArea.scrollHeight > contentArea.clientHeight) {
                // ç§»é™¤åˆšæ‰æ·»åŠ çš„è¯å—
                contentArea.removeChild(wordBlock);
                
                // æ–°å»ºä¸€é¡µ
                pageCount++;
                currentPage = createPage();
                currentPage.querySelector('.sheet-footer').innerText = `- ç¬¬ ${pageCount} é¡µ -`;
                previewArea.appendChild(currentPage);
                contentArea = currentPage.querySelector('.sheet-content');
                
                // åœ¨æ–°é¡µæ·»åŠ 
                contentArea.appendChild(wordBlock);
            }
        });
    }

    // åˆå§‹åŒ–è¿è¡Œ
    window.onload = () => {
        updateStyles();
        render();
    };
</script>
</body>
</html>
